server {
    listen 80;
    server_name im.ec2.proptiger-ws.com;

    # Logs
    access_log /var/log/nginx/images/im.ec2.proptiger-ws.com.access.log;
    error_log /var/log/nginx/images/im.ec2.proptiger-ws.com.error.log warn;
    # DNS
    resolver 8.8.8.8;
    # Variables
    set $s3 "https://im.proptiger-ws.com.s3.amazonaws.com";

    location ~* ^/images/.+$ {
        rewrite ^/images/(.+)$ /$1 last;
    }

    location / {
        set $flag "";
        if ($arg_width ~ '^\d+$') {
            set $flag "${flag}W";
        }
        if ($arg_height ~ '^\d+$') {
            set $flag "${flag}H";
        }
        if ($flag = "WH") {
            rewrite ^ /resize/${arg_width}/${arg_height}${uri} last;
        }
        if ($flag = "") {
            rewrite ^ /fullsize${uri} last;
        }
        return 400;
    }

    location ~* ^/resize/([\d\-]+)/([\d\-]+)/(.+)$ {
        proxy_pass $s3/$3;
        # Cache-Control headers
        expires 5y;
        add_header Cache-Control "public, s-maxage=157680000";
        # Resize logic
        image_filter_jpeg_quality 95;
        image_filter resize $1 $2;
        image_filter_buffer 50M;
        error_page 415 = /empty;
    }

    location ~* ^/fullsize/(.+)$ {
        proxy_pass $s3/$1;
        # Cache-Control headers
        expires 5y;
        add_header Cache-Control "public, s-maxage=157680000";
    }

    location = /empty {
        empty_gif;
    }
}
